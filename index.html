<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8" />

    <script type="module" src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm"></script>
    <link rel="stylesheet" href="./Styles/style.css">
    <script type="module" src="./scripts/script.js"></script>
</head>

<body>
    <header style="display:flex; align-items:center; justify-content:space-between;">
        <img src="./assets/ilvo.png" alt="ILVO" style="height:50px;">
        <h1>Rekentool Voederwaardeprijs Rundvee</h1>
    </header>
    <div class="panel">
        <div id="wurInfo">
            <label><strong>Kies de VWP (bron WUR):</strong></label>

            <select id="dateSelect"></select>
            <div class="wur-box kvem">
                <strong>kVEM:</strong>
                <br>
                <span id="kVEMVal">–</span> c€
            </div>
            <div class="wur-box dve-melk">
                <strong>kg DVE-toeslag (Melk):</strong>
                <br>
                <span id="DVE_melkVal">–</span> c€
            </div>
            <div class="wur-box kvevi">
                <strong>kVEVI:</strong>
                <br>
                <span id="kVEVIVal">–</span> c€
            </div>
            <div class="wur-box dve-vlees">
                <strong>kg DVE-toeslag (Vlees):</strong>
                <br>
                <span id="DVE_vleesVal">–</span> c€
            </div>
        </div>
    </div>


    <div id="categoriesContainer"></div>

    <!-- Buttons for Exports -->
    <div id="exportButtons" style="text-align:center; margin-top: 2rem;">
        <button id="exportExcelBtn" class="btn btn-success" style="margin-right:1rem;">Exporteren naar Excel</button>
        <button id="exportPdfBtn" class="btn btn-danger">Exporteren naar PDF</button>
    </div>


    <!-- 
        Let op – belangrijk:
        Ik heb het bestand 'footer-drupal.html.twig' aangemaakt voor de Drupal-versie.
        Zodra het project naar Drupal wordt overgezet, vervang deze sectie door de Twig-versie.
    -->

    <!-- Start Static Section -->
    <footer style="text-align:center; font-size:0.8rem; margin-top:2rem;">
        <div>
            <p>
                Deze rekentool combineert de voederwaardeprijzen (VWP) van Wageningen
                Livestock Research en de voederwaardes uit de CVB Veevoedertabel. Hierdoor kan
                je voor een grote reeks voedermiddelen een voederwaardeprijs bepalen. Kies een
                VWP op recente datum of een bepaalde periode en selecteer vervolgens een of
                meer voedermiddelen. Per voedermiddel wordt een VWP Melk en VWP Vlees
                berekend. Geef je ook een reële prijs in, dan wordt deze relatief vergeleken met de
                VWP en in percentage uitgedrukt.
            </p>
        </div>

        <div>
            <p>
                Voederwaardeprijzen (WUR)
                Eens per vier weken berekent Wageningen Livestock Research de actuele
                voederwaardeprijzen voor melkvee (VEM en DVE) en voor vleesvee (VEVI en DVE)
                op basis van een reeks mengvoeders die in de praktijk worden gebruikt. De
                energieprijs en de eiwittoeslagprijs voor voedermiddelen worden gebruikt bij de
                vergelijking van prijzen van rundveevoeders met hun voederwaarde, waarbij de
                aankoopprijs van een product wordt uitgedrukt als een percentage van de
                voederwaardeprijs. In een tekortsituatie kunnen producten met een aankoop-
                /voederwaardeprijs onder de 100% financieel aantrekkelijk zijn om aan te schaffen,
                mits ze voedingstechnisch in het rantsoen passen.
                <a id="wurLink" href="#">Voederwaardeprijzen (WUR)</a>
            </p>
        </div>

        <div>
            <p>
                Veevoedertabel (CVB)
                In de CVB Veevoedertabel bundelt het CVB (Centraal Veevoeder Bureau) voor een
                groot aantal grondstoffen de nutriëntwaarden, (berekende) verteringscoëfficiënten en
                voederwaarden voor herkauwers, paarden, schapen, varkens, pluimvee en konijnen.
                Aan de hand van deze gegevens kunnen rantsoenen voor bijvoorbeeld runderen
                worden samengesteld, afgestemd op de behoefte normen van de dieren. Ook deze
                behoeftenormen worden door het CVB bepaald en gebundeld aangeboden in het
                <a id="cvbTabellenboekLink" href="#">Tabellenboek veevoeding Herkauwers <span
                        id="currentYear"></span></a>.
                <br>
                <a id="cvbTableLink" href="#">CVB – Veevoedertabel</a>
            </p>
        </div>

        <div style="margin-top:0.5rem;">
            <img src="./assets/wageningen.svg" alt="WUR" style="height:40px; margin:0 10px;">
            <img src="./assets/cvb.jpeg" alt="CVB" style="height:40px; margin:0 10px;">
        </div>
    </footer>

    
    <script>
        const currentYear = new Date().getFullYear();
        const wurUrl = 'https://www.wur.nl/nl/onderzoek-resultaten/onderzoeksinstituten/livestock-research/producten/voederwaardeprijzen-rundvee.htm';
        const cvbTableUrl = 'https://www.cvbdiervoeding.nl/pagina/10081/downloads.aspx';
        const cvbTabellenboekUrl = `https://www.cvbdiervoeding.nl/bestand/10942/tabellenboek-veevoeding-herkauwers-${currentYear}.pdf.ashx`;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('wurLink').href = wurUrl;
            document.getElementById('cvbTableLink').href = cvbTableUrl;
            document.getElementById('cvbTabellenboekLink').href = cvbTabellenboekUrl;
            document.getElementById('currentYear').textContent = currentYear;
        });
    </script>

    <!-- End Static Section -->

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Export Data to Excel
        document.getElementById("exportExcelBtn").addEventListener("click", function () {
            const wb = XLSX.utils.book_new();
            const tables = document.querySelectorAll("table");

            tables.forEach((table, i) => {
                const cat = table.closest(".category-section")?.querySelector(".category-header")?.textContent || `Categorie ${i + 1}`;
                const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
                const rows = Array.from(table.querySelectorAll("tbody tr"));

                const filteredData = rows.map(row => {
                    const tds = row.querySelectorAll("td");
                    const productSelect = tds[0]?.querySelector("select");
                    const priceInput = tds[1]?.querySelector("input");
                    const product = productSelect ? productSelect.value : "";
                    const price = priceInput ? priceInput.value : "";

                    if (!price) return null;

                    const vwpMelk = tds[2]?.innerText.trim();
                    const vwpVlees = tds[3]?.innerText.trim();
                    const ds = tds[4]?.innerText.trim();
                    const dve = tds[5]?.innerText.trim();
                    const vem = tds[6]?.innerText.trim();
                    const vevi = tds[7]?.innerText.trim();
                    const percMelk = tds[8]?.innerText.trim();
                    const percVlees = tds[9]?.innerText.trim();

                    return [product, price, vwpMelk, vwpVlees, ds, dve, vem, vevi, percMelk, percVlees];
                }).filter(Boolean);

                if (filteredData.length > 0) {
                    const wsData = [
                        [`Categorie: ${cat}`],
                        headers.slice(0, 10),
                        ...filteredData
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, cat.substring(0, 31));
                }
            });

            if (wb.SheetNames.length === 0) {
                alert("Geen gegevens met ingevulde prijzen gevonden!");
                return;
            }

            XLSX.writeFile(wb, "Rekentool_Voederwaardeprijzen.xlsx");
        });

        // Export Data To Pdf
        document.getElementById("exportPdfBtn").addEventListener("click", function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("l", "pt", "a4");
            const selectedDate = document.getElementById("dateSelect")?.value || "";
            doc.text(`Rekentool Voederwaardeprijs Rundvee – ${selectedDate}`, 40, 40);

            const tables = document.querySelectorAll("table");
            let startY = 60;
            let dataFound = false;

            tables.forEach((table, i) => {
                const cat = table.closest(".category-section")?.querySelector(".category-header")?.textContent || `Categorie ${i + 1}`;
                const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
                const rows = Array.from(table.querySelectorAll("tbody tr"));

                const filteredData = rows.map(row => {
                    const tds = row.querySelectorAll("td");
                    const productSelect = tds[0]?.querySelector("select");
                    const priceInput = tds[1]?.querySelector("input");
                    const product = productSelect ? productSelect.value : "";
                    const price = priceInput ? priceInput.value : "";

                    if (!price) return null;

                    const vwpMelk = tds[2]?.innerText.trim();
                    const vwpVlees = tds[3]?.innerText.trim();
                    const ds = tds[4]?.innerText.trim();
                    const dve = tds[5]?.innerText.trim();
                    const vem = tds[6]?.innerText.trim();
                    const vevi = tds[7]?.innerText.trim();
                    const percMelk = tds[8]?.innerText.trim();
                    const percVlees = tds[9]?.innerText.trim();

                    return [product, price, vwpMelk, vwpVlees, ds, dve, vem, vevi, percMelk, percVlees];
                }).filter(Boolean);

                if (filteredData.length > 0) {
                    dataFound = true;
                    doc.text(cat, 40, startY - 10);
                    doc.autoTable({
                        head: [headers.slice(0, 10)],
                        body: filteredData,
                        startY: startY,
                        theme: "grid",
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [46, 125, 50] }
                    });
                    startY = doc.lastAutoTable.finalY + 25;

                    if (startY > 500 && i < tables.length - 1) {
                        doc.addPage();
                        startY = 60;
                    }
                }
            });

            if (!dataFound) {
                alert("Geen gegevens met ingevulde prijzen gevonden!");
                return;
            }

            doc.save("Rekentool_Voederwaardeprijzen.pdf");
        });
    </script>


</body>

</html>